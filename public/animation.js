/*global d3:false, Exception:false */

var margin = {top: 20, right: 80, bottom: 30, left: 50},
    width = 100000,
    height = 400 - margin.top - margin.bottom;

var parseDate = d3.time.format("%Y-%m-%d").parse;

var x = d3.time.scale()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category10();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(d3.time.month);

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var line = d3.svg.line()
    .interpolate("basis")
    .x(function (d) { return x(d.date); })
    .y(function (d) { return y(d.value); });

var svg = d3.select("#d3").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


function render(data) {
    'use strict';

  color = d3.scale.category10().domain(["grid", "solar"]);

  data.forEach(function (d) {
    d.date = parseDate(d.date);
  });

  var cities = color.domain().map(function(name) {
    return {
      name: name,
      values: data.map(function (d) {
          return {date: d.date, value: +d.values[(name === "grid" ? 0 : 1)]};
      })
    };
  });

  x.domain(d3.extent(data, function (d) { return d.date; }));

  y.domain([
    d3.min(cities, function(c) { return d3.min(c.values, function(v) { return v.value; }); }),
    d3.max(cities, function(c) { return d3.max(c.values, function(v) { return v.value; }); })
  ]);

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  /*
  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Temperature (ÂºF)");
  */

  var city = svg.selectAll(".city")
      .data(cities)
    .enter().append("g")
      .attr("class", "city");

  city.append("path")
      .attr("class", "line")
      .attr("d", function (d) { return line(d.values); })
      .style("stroke", function (d) { return color(d.name); });

  // city.append("text")
  //     .datum(function (d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
  //     .attr("transform", function (d) { return "translate(" + x(d.value.date) + "," + y(d.value) + ")"; })
  //     .attr("x", 3)
  //     .attr("dy", ".35em")
  //     .text(function (d) { return d.name; });

    console.log("Render done");

    $("#d3 svg").animate(
        {"margin-left": -100000 + window.innerWidth},
        30000,
        "easeInOutQuad",
        function () {
            console.log("animation 1 done");
        }
    );
}

var theResponse = {"data":[["2015-05-01",278,94],["2015-06-01",278,94],["2015-07-01",278,94],["2015-08-01",278,94],["2015-09-01",278,94],["2015-10-01",278,94],["2015-11-01",278,94],["2015-12-01",278,94],["2016-01-01",278,94],["2016-02-01",278,94],["2016-03-01",278,94],["2016-04-01",278,94],["2016-05-01",289,113],["2016-06-01",289,113],["2016-07-01",289,113],["2016-08-01",289,113],["2016-09-01",289,113],["2016-10-01",289,113],["2016-11-01",289,113],["2016-12-01",289,113],["2017-01-01",289,113],["2017-02-01",289,113],["2017-03-01",289,113],["2017-04-01",289,113],["2017-05-01",301,116],["2017-06-01",301,116],["2017-07-01",301,116],["2017-08-01",301,116],["2017-09-01",301,116],["2017-10-01",301,116],["2017-11-01",301,116],["2017-12-01",301,116],["2018-01-01",301,116],["2018-02-01",301,116],["2018-03-01",301,116],["2018-04-01",301,116],["2018-05-01",313,118],["2018-06-01",313,118],["2018-07-01",313,118],["2018-08-01",313,118],["2018-09-01",313,118],["2018-10-01",313,118],["2018-11-01",313,118],["2018-12-01",313,118],["2019-01-01",313,118],["2019-02-01",313,118],["2019-03-01",313,118],["2019-04-01",313,118],["2019-05-01",325,121],["2019-06-01",325,121],["2019-07-01",325,121],["2019-08-01",325,121],["2019-09-01",325,121],["2019-10-01",325,121],["2019-11-01",325,121],["2019-12-01",325,121],["2020-01-01",325,121],["2020-02-01",325,121],["2020-03-01",325,121],["2020-04-01",325,121],["2020-05-01",338,124],["2020-06-01",338,124],["2020-07-01",338,124],["2020-08-01",338,124],["2020-09-01",338,124],["2020-10-01",338,124],["2020-11-01",338,124],["2020-12-01",338,124],["2021-01-01",338,124],["2021-02-01",338,124],["2021-03-01",338,124],["2021-04-01",338,124],["2021-05-01",352,127],["2021-06-01",352,127],["2021-07-01",352,127],["2021-08-01",352,127],["2021-09-01",352,127],["2021-10-01",352,127],["2021-11-01",352,127],["2021-12-01",352,127],["2022-01-01",352,127],["2022-02-01",352,127],["2022-03-01",352,127],["2022-04-01",352,127],["2022-05-01",366,130],["2022-06-01",366,130],["2022-07-01",366,130],["2022-08-01",366,130],["2022-09-01",366,130],["2022-10-01",366,130],["2022-11-01",366,130],["2022-12-01",366,130],["2023-01-01",366,130],["2023-02-01",366,130],["2023-03-01",366,130],["2023-04-01",366,130],["2023-05-01",380,134],["2023-06-01",380,134],["2023-07-01",380,134],["2023-08-01",380,134],["2023-09-01",380,134],["2023-10-01",380,134],["2023-11-01",380,134],["2023-12-01",380,134],["2024-01-01",380,134],["2024-02-01",380,134],["2024-03-01",380,134],["2024-04-01",380,134],["2024-05-01",396,138],["2024-06-01",396,138],["2024-07-01",396,138],["2024-08-01",396,138],["2024-09-01",396,138],["2024-10-01",396,138],["2024-11-01",396,138],["2024-12-01",396,138],["2025-01-01",396,138],["2025-02-01",396,138],["2025-03-01",396,138],["2025-04-01",396,138],["2025-05-01",411,142],["2025-06-01",411,142],["2025-07-01",411,142],["2025-08-01",411,142],["2025-09-01",411,142],["2025-10-01",411,142],["2025-11-01",411,142],["2025-12-01",411,142],["2026-01-01",411,142],["2026-02-01",411,142],["2026-03-01",411,142],["2026-04-01",411,142],["2026-05-01",428,146],["2026-06-01",428,146],["2026-07-01",428,146],["2026-08-01",428,146],["2026-09-01",428,146],["2026-10-01",428,146],["2026-11-01",428,146],["2026-12-01",428,146],["2027-01-01",428,146],["2027-02-01",428,146],["2027-03-01",428,146],["2027-04-01",428,146],["2027-05-01",445,150],["2027-06-01",445,150],["2027-07-01",445,150],["2027-08-01",445,150],["2027-09-01",445,150],["2027-10-01",445,150],["2027-11-01",445,150],["2027-12-01",445,150],["2028-01-01",445,150],["2028-02-01",445,150],["2028-03-01",445,150],["2028-04-01",445,150],["2028-05-01",463,155],["2028-06-01",463,155],["2028-07-01",463,155],["2028-08-01",463,155],["2028-09-01",463,155],["2028-10-01",463,155],["2028-11-01",463,155],["2028-12-01",463,155],["2029-01-01",463,155],["2029-02-01",463,155],["2029-03-01",463,155],["2029-04-01",463,155],["2029-05-01",481,339],["2029-06-01",481,339],["2029-07-01",481,339],["2029-08-01",481,339],["2029-09-01",481,339],["2029-10-01",481,339],["2029-11-01",481,339],["2029-12-01",481,339],["2030-01-01",481,339],["2030-02-01",481,339],["2030-03-01",481,339],["2030-04-01",481,339],["2030-05-01",501,165],["2030-06-01",501,165],["2030-07-01",501,165],["2030-08-01",501,165],["2030-09-01",501,165],["2030-10-01",501,165],["2030-11-01",501,165],["2030-12-01",501,165],["2031-01-01",501,165],["2031-02-01",501,165],["2031-03-01",501,165],["2031-04-01",501,165],["2031-05-01",521,171],["2031-06-01",521,171],["2031-07-01",521,171],["2031-08-01",521,171],["2031-09-01",521,171],["2031-10-01",521,171],["2031-11-01",521,171],["2031-12-01",521,171],["2032-01-01",521,171],["2032-02-01",521,171],["2032-03-01",521,171],["2032-04-01",521,171],["2032-05-01",541,177],["2032-06-01",541,177],["2032-07-01",541,177],["2032-08-01",541,177],["2032-09-01",541,177],["2032-10-01",541,177],["2032-11-01",541,177],["2032-12-01",541,177],["2033-01-01",541,177],["2033-02-01",541,177],["2033-03-01",541,177],["2033-04-01",541,177],["2033-05-01",563,183],["2033-06-01",563,183],["2033-07-01",563,183],["2033-08-01",563,183],["2033-09-01",563,183],["2033-10-01",563,183],["2033-11-01",563,183],["2033-12-01",563,183],["2034-01-01",563,183],["2034-02-01",563,183],["2034-03-01",563,183],["2034-04-01",563,183],["2034-05-01",586,190],["2034-06-01",586,190],["2034-07-01",586,190],["2034-08-01",586,190],["2034-09-01",586,190],["2034-10-01",586,190],["2034-11-01",586,190],["2034-12-01",586,190],["2035-01-01",586,190],["2035-02-01",586,190],["2035-03-01",586,190],["2035-04-01",586,190],["2035-05-01",609,197],["2035-06-01",609,197],["2035-07-01",609,197],["2035-08-01",609,197],["2035-09-01",609,197],["2035-10-01",609,197],["2035-11-01",609,197],["2035-12-01",609,197],["2036-01-01",609,197],["2036-02-01",609,197],["2036-03-01",609,197],["2036-04-01",609,197],["2036-05-01",633,204],["2036-06-01",633,204],["2036-07-01",633,204],["2036-08-01",633,204],["2036-09-01",633,204],["2036-10-01",633,204],["2036-11-01",633,204],["2036-12-01",633,204],["2037-01-01",633,204],["2037-02-01",633,204],["2037-03-01",633,204],["2037-04-01",633,204],["2037-05-01",659,212],["2037-06-01",659,212],["2037-07-01",659,212],["2037-08-01",659,212],["2037-09-01",659,212],["2037-10-01",659,212],["2037-11-01",659,212],["2037-12-01",659,212],["2038-01-01",659,212],["2038-02-01",659,212],["2038-03-01",659,212],["2038-04-01",659,212],["2038-05-01",685,221],["2038-06-01",685,221],["2038-07-01",685,221],["2038-08-01",685,221],["2038-09-01",685,221],["2038-10-01",685,221],["2038-11-01",685,221],["2038-12-01",685,221],["2039-01-01",685,221],["2039-02-01",685,221],["2039-03-01",685,221],["2039-04-01",685,221],["2039-05-01",713,229],["2039-06-01",713,229],["2039-07-01",713,229],["2039-08-01",713,229],["2039-09-01",713,229],["2039-10-01",713,229],["2039-11-01",713,229],["2039-12-01",713,229],["2040-01-01",713,229],["2040-02-01",713,229],["2040-03-01",713,229],["2040-04-01",713,229]]};

render(theResponse.data.map(function (row) { return { date: row[0], values: [row[1], row[2]] }; }));

console.log(data[0].values);
